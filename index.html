<script>
    const form = document.getElementById('f');
    const out = document.getElementById('out');
    const load = document.getElementById('load');
    const results = document.getElementById('results');
    const submitBtn = document.getElementById('submitBtn');
    const tiers = { budget: document.getElementById('budget'), mid: document.getElementById('mid'), pro: document.getElementById('pro') };
    const tipsList = document.getElementById('tips');

    form.addEventListener('submit', async e => {
        e.preventDefault();
        out.style.display = 'block';
        load.style.display = 'block';
        results.style.display = 'none';
        submitBtn.disabled = true;
        submitBtn.textContent = 'Working…';
        for (const tier in tiers) tiers[tier].innerHTML = '';
        tipsList.innerHTML = '';

        const loc = document.getElementById('loc').value.trim();
        const date = document.getElementById('date').value || 'current season';
        const species = document.getElementById('species').value.trim();
        const body = document.getElementById('body').value;
        const type = document.getElementById('type').value;
        const speciesPart = species ? `Target species: ${species}\n` : '';

        const prompt = `You are the #1 professional angler and tackle expert who can recommend the best gear for the appropriate request. Return ONLY valid Amazon products with real ASINs.
${speciesPart}Location: ${loc}
Date/Season: ${date}
Water: ${body}
Technique: ${type}

Output EXACTLY this format (include ASIN in parentheses):
BUDGET:
1. Rod → Ugly Stik GX2 (ASIN: B00F0KBPFK)
2. Reel → ...
...
MID-RANGE:
...
PRO:
...
TIPS:
1. ...
...`;

        try {
            const res = await fetch('/api/recommend', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt })
            });

            if (!res.ok) throw new Error(`HTTP ${res.status}`);

            const data = await res.json();

            // ←←← THIS IS THE FIX — handles every possible backend format
            let text = '';
            if (typeof data === 'string') text = data;
            else if (data.choices?.[0]?.message?.content) text = data.choices[0].message.content;
            else if (data.response) text = data.response;
            else if (data.text) text = data.text;
            else if (data.content) text = data.content;
            else if (data.result) text = data.result;
            else throw new Error('Unexpected response format');

            if (!text.includes('BUDGET:')) throw new Error('AI did not follow format');

            // Extract all ASINs safely
            const asinRegex = /ASIN:\s*([A-Z0-9]{10})/gi;
            const asins = [...text.matchAll(asinRegex)].map(m => m[1]).slice(0, 30);

            let products = [];
            if (asins.length > 0) {
                const prodRes = await fetch('/api/amazon-products', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ asins })
                });
                products = await prodRes.json();
            }
            const productMap = {};
            products.forEach(p => productMap[p.ASIN] = p);

            // Parse sections
            const sectionRegex = /\n(BUDGET|MID-RANGE|PRO|TIPS):/g;
            const parts = text.split(sectionRegex);
            for (let i = 1; i < parts.length; i += 2) {
                const tierName = parts[i].trim();
                const content = parts[i + 1] || '';

                const targetDiv = tierName === 'TIPS' ? tipsList : tiers[tierName.toLowerCase().includes('budget') ? 'budget' : tierName.toLowerCase().includes('mid') ? 'mid' : 'pro'];

                content.split('\n')
                    .filter(line => /^\d+\./.test(line.trim()))
                    .forEach(line => {
                        const cleanLine = line.trim();
                        const asinMatch = cleanLine.match(/ASIN:\s*([A-Z0-9]{10})/i);
                        const asin = asinMatch ? asinMatch[1] : null;
                        const title = cleanLine.split('→')[1]?.replace(/\s*\(ASIN:.*\)/i, '').trim() || 'Unknown Product';

                        if (tierName === 'TIPS') {
                            const li = document.createElement('li');
                            li.style.cssText = 'background:white;padding:16px;margin:12px 0;border-radius:10px;';
                            li.textContent = cleanLine;
                            targetDiv.appendChild(li);
                            return;
                        }

                        const product = asin ? productMap[asin] : null;

                        const card = document.createElement('div');
                        card.className = 'product-card';
                        card.innerHTML = `
                            ${product?.Images?.Primary?.Medium?.URL ? `<img src="${product.Images.Primary.Medium.URL}" alt="${title}">` : '<div style="width:120px;height:120px;background:#eee;display:flex;align-items:center;justify-content:center;color:#999;font-size:0.9em;">No image</div>'}
                            <div class="product-info">
                                <div class="product-title">${title}</div>
                                ${product?.Offers?.Listings?.[0]?.Price ? `<div class="price">$${product.Offers.Listings[0].Price.Amount}</div>` : '<div class="price">Price unavailable</div>'}
                                ${product?.Offers?.Listings?.[0]?.DeliveryInfo?.IsPrimeEligible ? '<span class="prime">✓ Prime</span>' : ''}
                                <a href="https://www.amazon.com/dp/${asin || ''}?tag=fishingtac0b6-20" target="_blank" class="buy-btn">Buy Now →</a>
                            </div>`;
                        targetDiv.appendChild(card);
                    });
            }

            load.style.display = 'none';
            results.style.display = 'block';
            results.scrollIntoView({ behavior: 'smooth' });

        } catch (err) {
            console.error(err);
            load.innerHTML = `<p style="color:#e74c3c;font-size:1.5em;">Error: ${err.message}<br><br>Check browser console (F12) for details.</p>`;
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Get My Tackle List →';
        }
    });
</script>
